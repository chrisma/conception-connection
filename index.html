<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <!-- START Facebook OpenGraph -->
    <meta property="og:title" content="Conception Connection"/>
    <meta property="og:site_name" content="Conception Connection"/>
    <meta property="og:url" content="http://conception-connection.cf"/>
    <meta property="og:description" content="Find out what event led to your conception. An implementation of a webcomic." />
    <meta property="og:image" content="http://conception-connection.cf/preview.png"/>
    <!-- END Facebook OpenGraph -->
    <meta name="viewport" content="width=device-width">
    <title>Conception Connection</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="bootstrap.2.3.1.min.css" media="screen">
    <link rel="stylesheet" href="style.css">
    <link href='http://fonts.googleapis.com/css?family=Patrick+Hand+SC' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Droid+Sans:400' rel='stylesheet' type='text/css'>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="wiki_event.js"></script>
  </head>
  <body>
    <div class="content">
      <div class="element">
        <a href="/"><img src="frame.png"></a>
        <span>Conception Connection | implementing a <a href="http://www.smbc-comics.com/?id=2922" target="_blank">SMBC comic</a> by <a href="https://twitter.com/zachweiner">Zach Weiner</a></span>
      </div>

      <div class="element" id="input_div">
        <h1>Your date of birth:</h1>
          <div class="input-append">
            <input class="input-mini" id="day" type="text" maxlength="2">
            <span class="add-on">day</span>
          </div>
          <div class="input-append">
            <input class="input-mini" id="month" type="text" maxlength="2">
            <span class="add-on">month</span>
          </div>
          <div class="input-append">
            <input class="input-small" id="year" type="text" maxlength="4">
            <span class="add-on">year</span>
          </div>
          <button class="btn" id="button">Calculate</button>
          <div class="hidden" id="errorDiv">
            <span class="help-inline">Please enter a valid date.</span>
          </div>
      </div>
      
      <div class="element hidden" id="loader">
        <img src="loader.gif">
      </div>

      <div class="element hidden" id="no_event_in_range">
        <h1>Sorry, no important historical event could be found within <span class="weeks"></span> week(s) of conception.</h1>
        <form class="dateform" action="/" method="post">
          <div class="hidden">
            <input name="day" type="text" value="">
            <input name="month" type="text" value="">
            <input name="year" type="text" value="">
            <input name="range_from" type="text" value="">
            <input name="range_to" type="text" value="">
          </div>
          <input class="btn btn-link" type="submit" value="Try again with more variance." />
        </form>
      </div>
      
      <div class="element hidden" id="result">
        <h1>Most likely historical event that aroused your parents:</h1>
        <div class="well">
          <span id="event"></span>
        </div>
        <p class="small">Assuming a normal 38 (+/-<span class="weeks"></span>) week pregnancy. Day of conception: <span id="event_date"></span>.</p>
      </div>

    </div>

    <script type="text/javascript">
      function hashParm(parmName) {
          // assumes parm≈Éame doesn't contain regex characters
          var re = new RegExp("#.*" + parmName + "=([^&]+)(&|$)");
          var match = location.hash.match(re);
          return(match ? match[1] : "");
      }

      function validDate() {
        var emptyFields = $("#input_div input").filter(function(){
          return $(this).val().trim() === "";
        })
        if ( emptyFields.length ) return false;

        var year = $('#year').val();
        var month = $('#month').val()-1;
        var day = $('#day').val();

        var date = new Date(year,month,day);
        if ( date == "Invalid Date" ) return false;

        if ( year != date.getFullYear()) return false;
        if ( month != date.getMonth()) return false;
        if ( day != date.getDate()) return false;

        return date
      }

      if ( location.hash ) {
        var paramDay = new Date(Date.parse(hashParm('birthday')))
        $('#year').val(paramDay.getFullYear());
        $('#month').val(paramDay.getMonth()+1);
        $('#day').val(paramDay.getDate());
        run();
      }

      var variance = parseInt(hashParm('variance')) || 7

      $('#button').click(function() {
        run();
      });

      function run(){
        var bday = validDate();
        if ( !validDate(bday) ) {
          // showInvalidDateError();
          console.log("INVALID DATE");
          return
        }
        $('#input_div').hide();
        $('#loader').show();

        var conception = addDays(bday, -266);
        console.log(conception);
        fetchEvents(conception, variance, function(events){
          $('#loader').hide();
          $('#event').text(events[0].description);
          $('#result').show();
        });
      }
    </script>
  </body>
</html>
